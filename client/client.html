<!DOCTYPE html>
<html lang="en">
<head>
	<title>API Project: Poker</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
	<script type="text/babel">

	</script>
</head>
<body>
	<section id="top">
		<h3>Poker</h3>
		<form id="nameForm" action="/joinGame" method="post">
			<label for="name">Name: </label>
			<input id="nameField" type="text" name="name" />
			<input type="submit" value="Add Player" />
		</form>
		<button id="ready">Ready (all player test)</button>
		<button id="showDeck">Show deck (debug)</button>
		<button id="showCards">Show hands (debug)</button>
		<button id="reset">Reset (debug)</button>

	</section>
	<section id="content">
	</section>

	<script>
		let name = "";
		let urlField = document.querySelector("select#urlField");
		let methodSelect = document.querySelector("select#methodSelect");
		let nameForm = document.querySelector("form#nameForm");
		let showCardsButton = document.querySelector("button#showCards");
		let readyButton = document.querySelector("button#ready");
		let showDeckButton = document.querySelector("button#showDeck");
		let resetButton = document.querySelector("button#reset");

		//Add event to submit to prevent typical form behavior
		nameForm.addEventListener("submit", (e) => {
			let data = Object.fromEntries(new FormData(nameForm).entries());
			e.preventDefault();

			const xhr = new XMLHttpRequest();
			xhr.open(nameForm.method, nameForm.action, true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.addEventListener("load", (e) => {
				updateContent(nameForm.method, e.target);
				name = data.name;
			});
			xhr.addEventListener("error", () => {
				console.log("An error occured when sending the request");
			});
			// console.log();
			xhr.send(JSON.stringify(data));
		});

		readyButton.addEventListener("click", (e) => {
			let data = {name: name};

			const xhr = new XMLHttpRequest();
			xhr.open("post", "/readyAll", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.addEventListener("load", (e) => {
				updateContent("post", e.target);
			});
			xhr.addEventListener("error", () => {
				console.log("An error occured when sending the request");
			});
			// console.log();
			xhr.send(JSON.stringify(data));

		});
		// readyButton.addEventListener("click", (e) => {
		// 	let data = {name: name};

		// 	const xhr = new XMLHttpRequest();
		// 	xhr.open("post", "/playerReady", true);
		// 	xhr.setRequestHeader("Content-Type", "application/json");
		// 	xhr.addEventListener("load", (e) => {
		// 		updateContent("post", e.target);
		// 	});
		// 	xhr.addEventListener("error", () => {
		// 		console.log("An error occured when sending the request");
		// 	});
		// 	// console.log();
		// 	xhr.send(JSON.stringify(data));

		// });

		showCardsButton.addEventListener("click", (e) => {
			const xhr = new XMLHttpRequest();
			xhr.open("get", "/getHands", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.addEventListener("load", (e) => {
				updateContent("get", e.target);
			});
			xhr.addEventListener("error", () => {
				console.log("An error occured when sending the request");
			});
			xhr.send();
		});

		showDeckButton.addEventListener("click", (e) => {
			const xhr = new XMLHttpRequest();
			xhr.open("get", "/getCards", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.addEventListener("load", (e) => {
				updateContent("post", e.target);
			});
			xhr.addEventListener("error", () => {
				console.log("An error occured when sending the request");
			});
			xhr.send();

		});

		resetButton.addEventListener("click", (e) => {
			const xhr = new XMLHttpRequest();
			xhr.open("get", "/reset", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.addEventListener("load", (e) => {
				updateContent("get", e.target);
			});
			xhr.addEventListener("error", () => {
				console.log("An error occured when sending the request");
			});
			xhr.send();

		});

		function update(){
			pollServer();
		}

		setInterval(() => { update(); }, 100);

		function pollServer(){
			let data = {};
			const xhr = new XMLHttpRequest();
			xhr.open("get", "/pollGame", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.addEventListener("load", (e) => {
				let responseJSON = {};
				if (e.target.response){
					responseJSON = JSON.parse(e.target.response);
				}
				// console.log(e.resp);
				if (responseJSON.id == "Winner found"){
					updateContent("get", e.target);
				}
				// updateContent(nameForm.method, e.target);
			});
			xhr.addEventListener("error", () => {
				console.log("An error occured when sending the request");
			});
			// console.log();
			xhr.send(JSON.stringify(data));
		}

		function updateContent(method, request){
			let status = document.createElement("h1");
			let message = document.createElement("h3");
			let content = document.querySelector("section#content");
			content.innerHTML = "";

			switch (method.toLowerCase()){
				default:
					//GET and POST
					// console.log(request.responseJSON);
					if (request.response){
						let responseJSON = JSON.parse(request.response);
						status.innerHTML = responseJSON.id;
						message.innerHTML = responseJSON.message;
					}else{
						if (method.toLowerCase() == "post" && request.status == 204){
							status.innerHTML = "User updated";
						}
					}
					// console.log(request.response);
					break;
				case "head":
					switch (request.status){
						default:
							status.innerHTML = request.status;
							break;
						case 200:
							status.innerHTML = request.status + ": Success";
							break;
						case 404:
							status.innerHTML = request.status + ": Not Found";
							break;
					}
					break;
				// case "post":

				// 	break;
			}

			content.append(status);
			content.append(message);
		}
 	</script>

</body>
</html>